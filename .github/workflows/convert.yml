name: Ruleset Auto Update

on:
  schedule:
    - cron: '0 17 * * *' # æ¯å¤© UTC 17:00 (åŒ—äº¬æ—¶é—´ 01:00) æ‰§è¡Œ

  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update_ruleset:
    runs-on: ubuntu-latest
    
    # Git é…ç½®ï¼Œç”¨äºåç»­çš„ push æ“ä½œ
    env:
      GIT_COMMITTER_NAME: GitHub Actions Bot
      GIT_COMMITTER_EMAIL: actions@github.com

    steps:
      # 0. Checkout code
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»é…ç½® token ä»¥å…è®¸åç»­çš„ push
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 1. ä¸‹è½½ã€è§£å‹ã€é‡å‘½åå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ mihomo
      - name: ğŸ“¥ Download and Setup Mihomo
        run: |
          # ä¸‹è½½å‹ç¼©åŒ…
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-compatible-v1.19.16.gz"
          curl -L $MIHOMO_URL -o mihomo.gz
          
          # è§£å‹
          gunzip mihomo.gz

          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x mihomo
          
      # 2. ä¸‹è½½ proxy.txt æ–‡ä»¶
      - name: â¬‡ï¸ Download proxy.txt Rules
        run: |
          RULES_URL="https://github.com/Loyalsoldier/clash-rules/raw/refs/heads/release/proxy.txt"
          curl -L $RULES_URL -o proxy.txt
          
      # 3. æ‰§è¡Œ mihomo convert-ruleset å‘½ä»¤
      - name: ğŸ› ï¸ Convert Ruleset
        run: |
          ./mihomo convert-ruleset domain yaml proxy.txt mrs/proxy.mrs
          
      # 4. Push proxy.mrs
      - name: ğŸ“¤ Commit and Push proxy.mrs
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–
          if git diff --exit-code mrs/proxy.mrs; then
            echo "proxy.mrs has no changes. Skipping commit."
          else
            # é…ç½® Git user
            git config user.name "${{ env.GIT_COMMITTER_NAME }}"
            git config user.email "${{ env.GIT_COMMITTER_EMAIL }}"
            
            # æ·»åŠ æ–‡ä»¶
            git add mrs/proxy.mrs
            
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ¤– Auto update"
            
            # æ¨é€æ›´æ”¹åˆ°å½“å‰åˆ†æ”¯
            git push
            echo "Successfully committed and pushed."
          fi
