name: Ruleset Auto Update

# æ¯å¤© UTC æ—¶é—´ 8:00 æ‰§è¡Œä¸€æ¬¡ã€‚
# è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8) æ˜¯æ¯å¤©ä¸‹åˆ 4:00ã€‚
# å¦‚æœæ‚¨å¸Œæœ›æ˜¯åŒ—äº¬æ—¶é—´æ—©ä¸Š 8:00 æ‰§è¡Œï¼Œè¯·å°† cron è®¾ç½®ä¸º '0 0 * * *' (UTC)ã€‚
# è¿™é‡Œä¸ºäº†åŒ¹é…â€œæ¯å¤© å…«ç‚¹æ‰§è¡Œä¸€æ¬¡â€çš„å­—é¢æ„æ€ï¼Œæˆ‘å‡å®šæ‚¨æŒ‡çš„æ˜¯**åŒ—äº¬æ—¶é—´**ã€‚
# **å¦‚æœæ‚¨å¸Œæœ›æ˜¯åŒ—äº¬æ—¶é—´æ—©ä¸Š 8:00 æ‰§è¡Œï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ cron è¡¨è¾¾å¼ï¼š**
on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00) æ‰§è¡Œ

  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  update_ruleset:
    runs-on: ubuntu-latest
    
    # Git é…ç½®ï¼Œç”¨äºåç»­çš„ push æ“ä½œ
    env:
      GIT_COMMITTER_NAME: GitHub Actions Bot
      GIT_COMMITTER_EMAIL: actions@github.com

    steps:
      # 0. Checkout code
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»é…ç½® token ä»¥å…è®¸åç»­çš„ push
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 1. ä¸‹è½½ã€è§£å‹ã€é‡å‘½åå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ mihomo
      - name: ğŸ“¥ Download and Setup Mihomo
        run: |
          # ä¸‹è½½å‹ç¼©åŒ…
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-compatible-v1.19.16.gz"
          curl -L $MIHOMO_URL -o mihomo.gz
          
          # è§£å‹
          gunzip mihomo.gz

          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x mihomo
          
      # 2. ä¸‹è½½ proxy.txt æ–‡ä»¶
      - name: â¬‡ï¸ Download proxy.txt Rules
        run: |
          RULES_URL="https://github.com/Loyalsoldier/surge-rules/raw/refs/heads/release/proxy.txt"
          curl -L $RULES_URL -o proxy.txt
          
      # 3. æ‰§è¡Œ mihomo convert-ruleset å‘½ä»¤
      - name: ğŸ› ï¸ Convert Ruleset
        run: |
          ./mihomo convert-ruleset domain text proxy.txt proxy.mrs
          
      # 4. Push proxy.mrs
      - name: ğŸ“¤ Commit and Push proxy.mrs
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–
          if git diff --exit-code proxy.mrs; then
            echo "proxy.mrs has no changes. Skipping commit."
          else
            # é…ç½® Git user
            git config user.name "${{ env.GIT_COMMITTER_NAME }}"
            git config user.email "${{ env.GIT_COMMITTER_EMAIL }}"
            
            # æ·»åŠ æ–‡ä»¶
            git add proxy.mrs
            
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ¤– Auto update: proxy.mrs ruleset"
            
            # æ¨é€æ›´æ”¹åˆ°å½“å‰åˆ†æ”¯
            git push
            echo "Successfully committed and pushed proxy.mrs."
          fi
